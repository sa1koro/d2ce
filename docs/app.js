class App{constructor(){new d1ce.Screen("info_screen").Print(d1ce.timestamp),this.log_screen=new d1ce.Screen("log_screen"),this.main_screen=new d1ce.Screen("main_screen"),this.touch_screen=new d1ce.Screen("touch_screen"),this.hand=new Hand(this.touch_screen),this.cubes=new Cubes(this.main_screen),this.touching=null;let t=new d1ce.Params("");t.Value("face")?this.fixed="face":t.Value("seed")?this.fixed="seed":t.Value("type")&&(t.Value("type").match(/([\+\-])(\d*)d(\d*)/)?this.fixed="face":this.fixed="type")}async Load(){await this.hand.Load(),await this.cubes.Load(),"face"==this.fixed?this.cubes.StartRolling():"seed"==this.fixed?this.cubes.StartRolling():this.cubes.StartReleased()}Store(){this.cubes.Store()}Update(){this.hand.Update(),this.hand.Tapped()?(this.cubes.StartRerolling(),this.touching=null):this.hand.Released()?("type"==this.fixed?this.cubes.StartReleased():"seed"==this.fixed||"face"==this.fixed?this.cubes.StartReleased(this.touching):this.hand.Released().Right()?this.cubes.StartChanging(1):this.hand.Released().Left()&&this.cubes.StartChanging(-1),this.touching=null):this.hand.Swiping()?"type"==this.fixed?this.cubes.StartReleased():"seed"==this.fixed||"face"==this.fixed?this.hand.Swiping().Up()?this.cubes.StartSelecting(this.touching,0):this.hand.Swiping().Down()&&this.cubes.StartSelecting(this.touching,1):this.hand.Swiping().Right()?this.cubes.StartHolding(1):this.hand.Swiping().Left()?this.cubes.StartHolding(-1):this.cubes.StartHolding(0):this.hand.Holding()?"type"==this.fixed?this.cubes.StartReleased():"seed"==this.fixed||"face"==this.fixed?this.cubes.StartSelecting(this.touching,1):this.cubes.StartHolding(0):this.hand.Touching()&&(this.touching=this.hand.Point(),this.cubes.StartTouching()),this.cubes.Update()}Draw(){}async Main(){for(await this.Load();;)this.suspend?this.Store():(this.Update(),this.Draw(),await d1ce.Engine.Wait(1e3/60))}async Suspend(){for(this.suspend=!0;this.suspend;)await d1ce.Engine.Wait(1e3/60)}static Instance(){return null==this.instance&&(this.instance=new App),this.instance}}window.onload=(()=>App.Instance().Main()),document.visibilitychange=(()=>App.Instance().Suspend());class Hand{constructor(t){this.screen=t,this.input=new d1ce.Input(t),this.count=0,this.touching=null,this.holding=null,this.tapped=null,this.swiping=null,this.released=null}async Load(){}Point(){return this.input.Point()}Touching(){return this.touching}StartTouching(){this.touching=this.input.Dirs(!0),this.input.Point()}Holding(){return this.holding}StartHolding(){this.holding=this.input.Dirs(!0),this.input.Point()}Swiping(){return this.swiping}StartSwiping(){this.swiping=this.input.Dirs(!0),this.input.Point()}Tapped(){return this.tapped}StartTapped(){this.tapped=this.input.Dirs(),this.input.Point()}Released(){return this.released}StartReleased(){this.released=this.input.Dirs(),this.input.Point()}Update(){this.touching=null,this.holding=null,this.tapped=null,this.swiping=null,this.released=null,this.input.UpdateDirs(1e3,2500,.5),null!=this.input.Dirs()?this.input.Dirs().IsEmpty()?this.StartTapped():this.StartReleased():null!=this.input.Dirs(!0)&&(this.input.Dirs(!0).Right()||this.input.Dirs(!0).Left()||this.input.Dirs(!0).Down()||this.input.Dirs(!0).Up()?this.StartSwiping():this.input.Dirs(!0).Far()?this.StartHolding():this.StartTouching()),this.input.Point()}}class Cubes{constructor(t){if(this.screen=t,this.sprites=null,this.sprite_selected=-1,this.query=new d1ce.Params(""),this.storage=new d1ce.Params(d1ce.identifier+"-option"),this.message=new d1ce.Params("*",!0),this.random=new d1ce.Count,this.update=null,this.count=0,this.app="",this.type="",this.type_plus=0,this.type_count=1,this.type_number=6,this.seed=0,this.face="",this.face_numbers=[],this.hold="",this.hold_numbers=[],this.query.Value("app")&&(this.app=this.query.Value("app"),this.message.UpdateValue("app",this.app,!0)),this.query.Value("tag")){let t=this.query.Value("tag");this.message.UpdateValue("tag",t,!0)}if(null==this.query.Value("type")&&null==this.query.Value("seed")&&null==this.query.Value("face")||(this.type=this.query.Value("type"),this.seed=this.query.Value("seed"),this.face=this.query.Value("face"),this.hold=this.query.Value("hold")),this.type.match(/([\+\-])(\d*)d(\d*)/)){let t=this.storage.Value("type"),e=1,s=6;t.match(/(\d*)d(\d*)/)&&t.replace(/(\d*)d(\d*)/,(t,i,h)=>{e=i>0?Number(i):1,s=h>0?Number(h):6});let i=this.storage.Value("face");this.type.replace(/\+(\d*)d(\d*)/,(t,s,h)=>{this.type_count=e+(s>0?Number(s):1),this.type_number=h>0?Number(h):6,this.type=this.type_count+"d"+this.type_number,this.seed=this.seed||0,this.face=i+(this.face?","+this.face:"")}),this.type.replace(/\-(\d*)d(\d*)/,(t,s,h)=>{this.type_count=e-(s>0?Number(s):1),this.type_number=h>0?Number(h):6,this.type=this.type_count+"d"+this.type_number,this.seed=this.seed||0,this.face=i+(this.face?","+this.face:"")}),this.message.UpdateValue("type",this.type,!0),this.message.UpdateValue("seed",this.seed,!0),this.message.UpdateValue("face",null)}if(""==this.type&&(this.type=this.storage.Value("type"),this.seed=this.storage.Value("seed"),this.face=this.storage.Value("face")),this.type.match(/(\d*)d(\d*)/)?this.type.replace(/(\d*)d(\d*)/,(t,e,s)=>{this.type_count=e>0?Number(e):1,this.type_number=s>0?Number(s):6}):isFinite(this.type)?(this.type_count=Number(this.type),this.type_number=6):(this.type="",this.type_count=1,this.type_number=6),this.type_count<1?this.type_count=1:this.type_count>Cubes.count_max&&(this.type_count=Cubes.count_max),this.type_number<1?this.type_number=1:this.type_number>Cubes.number_max&&(this.type_number=Cubes.number_max),isFinite(this.seed)||(this.seed=0),this.face_numbers=[],null!=this.face){let t=this.face.split(",");for(let e=0;e<this.type_count;++e)this.face_numbers.push(isFinite(t[e])?Number(t[e]):0);this.face=this.face_numbers.join(",")}else for(let t=0;t<this.type_count;++t)this.face_numbers.push(0);if(this.hold_numbers=[],null!=this.hold){let t=this.hold.split(",");for(let e=0;e<this.type_count;++e)this.hold_numbers.push(isFinite(t[e])?Number(t[e]):0);this.hold=this.hold_numbers.join(",")}else for(let t=0;t<this.type_count;++t)this.hold_numbers.push(0);this.storage.UpdateValue("type",this.type),this.storage.UpdateValue("seed",this.seed),this.storage.UpdateValue("face",this.face),this.random=new d1ce.Count(this.seed)}async Load(){let t="image/dot.png",e=192;this.app.match(/^(\w+)@(\d+)/)?this.app.replace(/^(\w+)@(\d+)/,(s,i,h)=>{t="image/"+i+".png",e=Number(h)}):""!=this.app?(t="image/"+this.app+".png",e=192):10==this.type_number?(t="image/num.png",e=192):this.type_number<=20?(t="image/dot.png",e=192):(t="image/card.png",e=192),this.sprites=[];for(let s=0;s<Cubes.count_max;++s)this.sprites[s]=new d1ce.Sprite("cubes"),this.sprites[s].LoadImage(t,e,e);for(let t=0;t<Cubes.count_max;++t)await this.sprites[t].WaitLoadingImage();for(let t=0;t<Cubes.count_max;++t)this.sprites[t].Enable(this.screen,t<this.type_count),1==this.type_count?this.sprites[t].SetScale(1):this.type_count<=4?this.sprites[t].SetScale(.75):this.type_count<=9?this.sprites[t].SetScale(.5):this.sprites[t].SetScale(.375)}Store(){}StartSelecting(t,e){if(this.update!=this.UpdateRolling){this.update=this.UpdateSelecting;for(let s=0;s<this.sprites.length;++s)this.sprites[s].IsInRect(t)&&(e?(this.sprites[s].SetAnime("holding"),this.hold_numbers[s]=e):(this.sprites[s].SetAnime("unselecting"),this.hold_numbers[s]=0))}}StartTouching(t=null){if(this.update==this.UpdateSelecting)for(let e=0;e<this.sprites.length;++e)t||this.hold_numbers[e]?this.sprites[e].IsInRect(t)&&this.sprites[e].SetAnime("reselecting"):this.sprites[e].SetAnime("reselecting");else if(this.update!=this.UpdateRolling){this.update=this.UpdateSelecting,this.message.UpdateValue("type",this.type,!0),this.message.UpdateValue("seed",this.seed,!0),this.message.UpdateValue("face",null);for(let e=0;e<this.sprites.length;++e)this.hold_numbers[e]?this.sprites[e].SetAnime("holding"):t||this.hold_numbers[e]?this.sprites[e].IsInRect(t)&&this.sprites[e].SetAnime("selecting"):this.sprites[e].SetAnime("selecting")}}StartRolled(){this.update=this.UpdateRolled,this.count=0,0==this.seed&&(this.seed=this.random.Seed());for(let t=0;t<this.type_count;++t)this.face_numbers[t]||(this.face_numbers[t]=this.random.Random(this.type_number)+1);this.face=this.face_numbers.join(","),this.storage.UpdateValue("type",this.type,!0),this.storage.UpdateValue("seed",this.seed,!0),this.storage.UpdateValue("face",this.face),this.message.UpdateValue("type",this.type,!0),this.message.UpdateValue("seed",this.seed,!0),this.message.UpdateValue("face",this.face);for(let t=0;t<this.sprites.length;++t)this.hold_numbers[t]||this.sprites[t].SetAnime("rolled")}StartRolling(){this.update=this.UpdateRolling,this.count=30;for(let t=0;t<this.face_numbers.length;++t)this.face_numbers[t]>0?this.sprites[t].SetAnime("rolled"):this.sprites[t].SetAnime("rolling")}StartRerolling(){this.update=this.UpdateRolling,this.count=30;for(let t=0;t<this.type_count;++t)this.hold_numbers[t]||(this.face_numbers[t]=0);this.face=this.face_numbers.join(","),this.message.UpdateValue("face",this.face,!0),this.hold=this.hold_numbers.join(","),this.message.UpdateValue("hold",this.hold);for(let t=0;t<this.sprites.length;++t)this.sprites[t].SetAnime("rolling")}StartHolding(t){this.update=this.UpdateHolding;for(let e=0;e<this.sprites.length;++e)this.hold_numbers[e]||(this.sprite_selected<0||this.sprite_selected==e)&&(t>0?this.sprites[e].SetAnime("swiping_right"):t<0?this.sprites[e].SetAnime("swiping_left"):this.sprites[e].SetAnime("holding"))}StartSelected(){this.update=this.UpdateReleased,this.face=this.face_numbers.join(","),this.message.UpdateValue("face",this.face,!0),this.hold=this.hold_numbers.join(","),this.message.UpdateValue("hold",this.hold);for(let t=0;t<this.sprites.length;++t)this.sprites[t].SetAnime("released")}StartReleased(){if(this.update!=this.UpdateRolling){this.update=this.UpdateSelecting;for(let t=0;t<this.sprites.length;++t)this.sprites[t].Enable(this.screen,t<this.type_count),1==this.type_count?this.sprites[t].SetScale(1):this.type_count<=4?this.sprites[t].SetScale(.75):this.type_count<=9?this.sprites[t].SetScale(.5):this.sprites[t].SetScale(.375);for(let t=0;t<this.sprites.length;++t)this.hold_numbers[t]||this.sprites[t].SetAnime("released")}}StartChanging(t){this.update=this.UpdateSelecting,this.sprites.length>=2&&(t>0?this.type_count>=Cubes.count_max?this.type_count=Cubes.count_max:this.type_count=this.type_count+1:t<0&&(this.type_count<=1?this.type_count=1:this.type_count=this.type_count-1)),0!=t&&(this.type=this.type_count+"d"+this.type_number,this.storage.UpdateValue("type",this.type),this.query.UpdateValue("type",this.type),this.message.UpdateValue("type",this.type,!0));for(let t=0;t<this.sprites.length;++t)this.sprites[t].Enable(this.screen,t<this.type_count),1==this.type_count?this.sprites[t].SetScale(1):this.type_count<=4?this.sprites[t].SetScale(.75):this.type_count<=9?this.sprites[t].SetScale(.5):this.sprites[t].SetScale(.375);for(let t=0;t<this.sprites.length;++t)this.sprites[t].SetAnime("changed")}UpdateSelecting(){let t=Math.floor(this.count/20)%this.type_number+1,e=[];for(let s=0;s<this.sprites.length;++s)this.face_numbers[s]>0?e.push(this.face_numbers[s]):e.push(t);for(let t=0;t<this.sprites.length;++t)t<this.type_count&&this.sprites[t].SetFrame(e[t]-1);this.count+=1}UpdateRolling(){let t=[];for(let e=0;e<this.sprites.length;++e)if(this.face_numbers[e]>0)t.push(this.face_numbers[e]);else{let e=d1ce.Engine.Random(this.type_number)+1;t.push(e)}for(let e=0;e<this.sprites.length;++e)e<t.length&&this.sprites[e].SetFrame(t[e]-1);this.count-=1,this.count<=0&&this.StartRolled()}UpdateRolled(){for(let t=0;t<this.sprites.length;++t)t<this.face_numbers.length&&this.sprites[t].SetFrame(this.face_numbers[t]-1);for(let t=0;t<this.sprites.length;++t)this.sprites[t].SetAnime("rolled")}UpdateHolding(){let t=Math.floor(this.count/20)%this.type_number+1,e=[];for(let s=0;s<this.sprites.length;++s)this.face_numbers[s]>0?e.push(this.face_numbers[s]):e.push(t);for(let t=0;t<this.sprites.length;++t)t<this.type_count&&this.sprites[t].SetFrame(e[t]-1);this.count+=1}Update(){null!=this.update&&this.update()}}Cubes.count_max=16,Cubes.number_max=54;